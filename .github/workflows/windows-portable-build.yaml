name: Portable Build for Windows

on:
  push:
    branches: ["main", "dev_20250611_add_vertical_screen_operate"]
  pull_request:
    branches: ["dev"]
  workflow_dispatch:

defaults:
  run:
    shell: cmd

env:
  ARTIFACT: openterfaceQT.windows.amd64.portable.exe
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 6.5.3 
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ORGANIZATION_NAME: "TechxArtisan"
  VCPKG_DIR: C:\vcpkg
  OPENSSL_DIR: C:\vcpkg\installed\x64-mingw-static
  MSYS2_DIR: C:\msys64
  EXTERNAL_MINGW: C:\mingw64
  FFMPEG_INSTALL_PREFIX: C:\ffmpeg-static

jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get FFmpeg script hash
        id: ffmpeg-script-hash
        run: |
          powershell -Command "$h=(Get-FileHash build-script/build-static-ffmpeg-windows.sh -Algorithm SHA256).Hash.Substring(0,8); echo \"hash=$h\" >> $env:GITHUB_OUTPUT"

      - name: Cache Qt Build
        id: cache-qt
        uses: actions/cache@v4
        with:
          path: C:\Qt6
          key: qt-${{ env.QT_VERSION }}-mingw-windows-static-openssl-v1
          restore-keys: |
            qt-${{ env.QT_VERSION }}-mingw-windows-static-openssl-

      - name: Cache MinGW and Ninja
        id: cache-mingw
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.EXTERNAL_MINGW }}
            C:\ProgramData\chocolatey\lib\ninja
          key: mingw-ninja-windows-static-v1
          restore-keys: |
            mingw-ninja-windows-static-

      - name: Cache vcpkg
        id: cache-vcpkg
        uses: actions/cache@v5
        with:
          path: ${{ env.VCPKG_DIR }}
          key: vcpkg-mingw-static-openssl-v3
          restore-keys: |
            vcpkg-mingw-static-openssl-

      - name: Cache FFmpeg build
        id: cache-ffmpeg
        uses: actions/cache@v4
        with:
          path: ${{ env.FFMPEG_INSTALL_PREFIX }}
          key: ffmpeg-static-6.1.1-${{ steps.ffmpeg-script-hash.outputs.hash }}
          restore-keys: |
            ffmpeg-static-6.1.1-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Build environment (MinGW + Ninja)
        if: steps.cache-mingw.outputs.cache-hit != 'true'
        run: |
          echo Installing Ninja...
          choco install ninja -y
    
          echo Downloading pre-compiled static MinGW-w64...
          curl -L -o mingw-w64.zip https://sourceforge.net/projects/mingw-w64/files/latest/download
          mkdir %EXTERNAL_MINGW%
          tar -xf mingw-w64.zip -C %EXTERNAL_MINGW% --strip-components=1
    
          echo Verifying MinGW installation...
          set PATH=%EXTERNAL_MINGW%\bin;%PATH%
          g++ --version || (echo "g++ installation failed" && exit /b 1)

      - name: Install vcpkg and all static dependencies
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          echo Cloning vcpkg...
          git clone https://github.com/microsoft/vcpkg.git %VCPKG_DIR%
          cd %VCPKG_DIR%
          call bootstrap-vcpkg.bat

          echo Installing static libraries for MinGW...
          call vcpkg install ^
            zlib:x64-mingw-static ^
            bzip2:x64-mingw-static ^
            liblzma:x64-mingw-static ^
            openssl:x64-mingw-static ^
            --triplet=x64-mingw-static ^
            --overlay-triplets="%SOURCE_DIR%/triplets" ^
            --clean-after-build

          call vcpkg integrate install

      - name: Verify vcpkg libraries
        run: |
          if not exist "%OPENSSL_DIR%\lib\libssl.a" (
            echo ERROR: libssl.a missing
            exit /b 1
          )
          if not exist "%OPENSSL_DIR%\lib\libcrypto.a" (
            echo ERROR: libcrypto.a missing
            exit /b 1
          )
          echo vcpkg libraries verified.

      - name: Install MSYS2 (shell + build tools only)
        run: |
          echo Installing MSYS2 via Chocolatey...
          choco install msys2 -y
          set PATH=%MSYS2_DIR%\usr\bin;%PATH%
          echo Updating and installing base tools...
          %MSYS2_DIR%\usr\bin\bash.exe -lc "pacman -Sy --noconfirm && pacman -S --needed --noconfirm base-devel git make cmake yasm nasm pkg-config"

      - name: Build FFmpeg (static) with external MinGW
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          echo Building FFmpeg using external MinGW (NO QSV)...
          set PATH=%EXTERNAL_MINGW%\bin;%MSYS2_DIR%\usr\bin;%PATH%
          call build-script\build-static-ffmpeg-windows.bat

      - name: Verify FFmpeg build output
        run: |
          if not exist "%FFMPEG_INSTALL_PREFIX%\lib\libavcodec.a" (
            echo ERROR: libavcodec.a not found
            dir "%FFMPEG_INSTALL_PREFIX%\lib"
            exit /b 1
          )
          echo FFmpeg static libraries built successfully.

      - name: Build Qt Statically
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          set PATH=%EXTERNAL_MINGW%\bin;%PATH%
          call build-script\build-static-qt-from-source.bat

      - name: Create build directory
        run: |
          mkdir %RUNNER_TEMP%\build

      - name: Prepare Driver Files
        run: |
          mkdir %SOURCE_DIR%\drivers\windows
          xcopy /E /I driver\windows %SOURCE_DIR%\drivers\windows

      - name: Update and Release Translations
        working-directory: "%RUNNER_TEMP%/build"
        run: |
          set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;%PATH%
          if not exist "C:\Qt6\bin\lupdate.exe" (
            echo ERROR: lupdate.exe not found
            exit /b 1
          )
          C:\Qt6\bin\lupdate.exe "%SOURCE_DIR%\openterfaceQT.pro"
          C:\Qt6\bin\lrelease.exe "%SOURCE_DIR%\openterfaceQT.pro"

      - name: Build Portable Executable
        working-directory: "%RUNNER_TEMP%/build"
        run: >-
          set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;C:\msys64\usr\bin;C:\ProgramData\chocolatey\bin;%PATH% &&
          cmake -G "Ninja"
          -DCMAKE_BUILD_TYPE=Release
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
          -DVCPKG_TARGET_TRIPLET="x64-mingw-static"
          -DCMAKE_PREFIX_PATH="C:/Qt6;C:/vcpkg/installed/x64-mingw-static"
          -DFFMPEG_PREFIX="C:/ffmpeg-static"
          -DFFMPEG_INCLUDE_DIR="C:/ffmpeg-static/include"
          -DFFMPEG_LIBRARIES="C:/ffmpeg-static/lib/libavcodec.a;C:/ffmpeg-static/lib/libavformat.a;C:/ffmpeg-static/lib/libavutil.a;C:/ffmpeg-static/lib/libswscale.a;C:/ffmpeg-static/lib/libswresample.a"
          -DZLIB_LIBRARY="C:/vcpkg/installed/x64-mingw-static/lib/libz.a"
          -DOPENTERFACE_BUILD_STATIC=ON
          -DCMAKE_C_COMPILER="%EXTERNAL_MINGW%\bin\gcc.exe"
          -DCMAKE_CXX_COMPILER="%EXTERNAL_MINGW%\bin\g++.exe"
          -DCMAKE_RC_COMPILER="%EXTERNAL_MINGW%\bin\windres.exe"
          "%SOURCE_DIR%" &&
          cmake --build . --config Release -- -j2 &&
          for /f "delims=" %F in ('dir /s /b openterfaceQT.exe 2^>nul') do set "EXE=%F" &&
          if not defined EXE (
            echo Build failed: openterfaceQT.exe not found && dir /s /b . && exit /b 1
          ) &&
          C:\msys64\usr\bin\objdump.exe -p "%EXE%" | C:\msys64\usr\bin\grep.exe -i "\.dll" >nul && (
            echo ERROR: DLL dependencies detected! && exit /b 1
          ) || (
            echo OK: No DLL dependencies.
          ) &&
          C:\msys64\usr\bin\strip.exe -s "%EXE%" &&
          md package &&
          cmake --install . --config Release --prefix package &&
          copy "%EXE%" package\openterfaceQT-portable.exe

      - name: Save build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}\build\package\openterfaceQT-portable.exe
          if-no-files-found: error