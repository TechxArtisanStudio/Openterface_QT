name: Portable Build for Windows (CMake + vcpkg + MinGW Static)

on:
  push:
    branches: ["main", "dev"]
    paths:
      - '.github/workflows/windows-portable-build.yaml'
      - 'vcpkg.json'
      - 'CMakeLists.txt'
      - '**/*.bat'
      - '**/*.cpp'
  pull_request:
    branches: ["dev"]
    paths:
      - '.github/workflows/windows-portable-build.yaml'
      - 'vcpkg.json'
      - 'CMakeLists.txt'
      - '**/*.bat'
      - '**/*.cpp'
      - '**/*.h'
  workflow_dispatch:

defaults:
  run:
    shell: cmd

env:
  ARTIFACT: openterfaceQT.windows.amd64.portable.exe
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 6.5.3
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  VCPKG_DIR: D:\vcpkg
  VCPKG_KEEP_BUILDTREES: 1
  EXTERNAL_MINGW: C:\mingw64
  VCPKG_MAX_CONCURRENCY: 1

jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Qt Build
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: C:\Qt6
          key: qt-6.5.3-mingw-windows-static-vcpkg
          restore-keys: |
            qt-6.5.3-mingw-windows-static-

      - name: Cache MinGW and Ninja
        id: cache-mingw
        uses: actions/cache@v3
        with:
          path: |
            C:\mingw64
            C:\ProgramData\chocolatey\lib\ninja
          key: mingw-ninja-static-2025
          restore-keys: |
            mingw-ninja-static-

      - name: Cache vcpkg
        id: cache-vcpkg
        uses: actions/cache@v3
        with:
          path: D:\vcpkg
          key: vcpkg-x64-mingw-static-openssl-ffmpeg-zlib-v1
          restore-keys: |
            vcpkg-x64-mingw-static-

      - name: Cache FFmpeg Build
        id: cache-ffmpeg
        uses: actions/cache@v3
        with:
          path: D:\vcpkg\installed\x64-mingw-static\lib
          key: ffmpeg-static-${{ runner.os }}-v1
          restore-keys: |
            ffmpeg-static-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ninja and MinGW (if not cached)
        if: steps.cache-mingw.outputs.cache-hit != 'true'
        run: |
          echo Installing Ninja...
          choco install ninja -y

          echo Downloading MinGW-w64 static build...
          curl -L -o mingw-w64.zip https://github.com/niXman/mingw-builds-binaries/releases/download/13.2.0-rt_v11-rev1/x86_64-13.2.0-release-win32-seh-ucrt-rt_v11-rev1.7z
          mkdir C:\mingw64_tmp
          7z x mingw-w64.zip -oC:\mingw64_tmp
          move C:\mingw64_tmp\x86_64-13.2.0-release-win32-seh-ucrt-rt_v11-rev1\* C:\mingw64\
          rmdir /s /q C:\mingw64_tmp

          echo Verifying g++...
          set PATH=C:\mingw64\bin;%PATH%
          g++ --version

          echo Installing assembly tools (nasm, yasm) that ffmpeg configure may require...
          choco install nasm -y || echo "nasm install failed or already installed"
          choco install yasm -y || echo "yasm install failed or already installed"

      - name: Setup MSYS2 (use action)
        uses: msys2/setup-msys2@v3
        with:
          update: true


      - name: Install Build Tools
        run: |
          echo "Installing Ninja"
          choco install ninja -y

          echo "Updating MSYS2 and installing MinGW-w64 toolchain..."
          C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash.exe -lc "pacman -Syu --noconfirm"
          C:\msys64\usr\bin\bash.exe -lc "pacman -S --needed --noconfirm --overwrite=* mingw-w64-x86_64-gcc mingw-w64-x86_64-cmake mingw-w64-x86_64-make mingw-w64-x86_64-libiconv mingw-w64-x86_64-bzip2 mingw-w64-x86_64-xz mingw-w64-x86_64-winpthreads"

          echo "Verifying compiler..."
          set PATH=C:\msys64\mingw64\bin;%PATH%
          g++ --version

      - name: Verify MinGW Static Linking Capability
        run: |
          set PATH=C:\msys64\mingw64\bin;%PATH%
          echo "Testing static compilation with MinGW..."
          echo #include ^<iostream^> > test.cpp
          echo int main() { std::cout ^<^< "Static build OK!" ^<^< std::endl; return 0; } >> test.cpp
          g++ -static -O2 -s -o test.exe test.cpp
          if errorlevel 1 (
            echo "❌ Failed to compile a static C++ program."
            exit /b 1
          )
          test.exe
          if errorlevel 1 (
            echo "❌ Compiled executable failed to run."
            exit /b 1
          )
          echo "✅ MinGW static linking verified successfully."
          echo "Listing all .a libraries in C:\msys64\mingw64\lib:"
          dir C:\msys64\mingw64\lib\*.a
          if not exist "C:\msys64\mingw64\lib\libbz2.a" (
            echo "❌ libbz2.a not found in MinGW lib directory."
            exit /b 1
          )
          echo "✅ libbz2.a verified."
          del test.cpp test.exe


      - name: Install or Update vcpkg (bootstrap only)
        run: |
          echo Cloning or updating vcpkg...
          if not exist "%VCPKG_DIR%\vcpkg.exe" (
            echo "vcpkg.exe not found, cloning vcpkg repo..."
            git clone https://github.com/microsoft/vcpkg.git %VCPKG_DIR%
            cd %VCPKG_DIR%
            git fetch --all --tags || echo "git fetch failed"
            call bootstrap-vcpkg.bat
          ) else (
            echo "%VCPKG_DIR%\vcpkg.exe already exists, updating vcpkg repo"
            cd %VCPKG_DIR%
            git fetch --all --tags || echo "git fetch failed"
            if defined VCPKG_BASELINE (
              git checkout %VCPKG_BASELINE% || git checkout tags/%VCPKG_BASELINE% || echo "git checkout baseline failed"
            ) else (
              git reset --hard origin/HEAD || echo "git reset failed"
            )
            call bootstrap-vcpkg.bat
          )

          cd "%SOURCE_DIR%"
          set VCPKG_LOG_LEVEL=debug
          set VCPKG_DOWNLOADS_RETRIES=5
          set VCPKG_MAX_CONCURRENCY=%VCPKG_MAX_CONCURRENCY%
          echo vcpkg version/loglevel: && "%VCPKG_DIR%\vcpkg.exe" version || echo "could not show vcpkg version"
          call "%VCPKG_DIR%\vcpkg.exe" integrate install
          echo vcpkg installed ports (end) && "%VCPKG_DIR%\vcpkg.exe" list || echo "couldn't list vcpkg packages"

      # vcpkg manifest will install pkgconf (manifest mode), which will create the msys2 root.

      - name: Install vcpkg manifest (zlib, openssl, pkgconf) using MSYS2
        # Run using bash so we can safely use cygpath and a POSIX-style invocation.
        shell: bash
        run: |
          echo "Installing static packages via manifest (vcpkg.json) using MSYS2"
          # If MSYS2 bash exists, convert the configured VCPKG_DIR to a unix path and run vcpkg there
          if [ -x "/c/msys64/usr/bin/bash" ]; then
            MSYS_VCPKG_DIR="$(cygpath -u "$VCPKG_DIR")"
            echo "Using MSYS2 path: $MSYS_VCPKG_DIR"
            cd "$MSYS_VCPKG_DIR" || exit 1
            ./vcpkg.exe install --triplet=x64-mingw-static --host-triplet=x64-mingw-static --clean-after-build || true
          else
            # Fallback to running the Windows vcpkg.exe via cmd if MSYS2 isn't present
            echo "MSYS2 not available - falling back to Windows vcpkg.exe"
            cmd.exe /C "\"%VCPKG_DIR%\\vcpkg.exe\" install --triplet=x64-mingw-static --host-triplet=x64-mingw-static --clean-after-build"
          fi

      - name: Ensure MSYS2 and packages for ffmpeg build (pkgconf, nasm, yasm)
        run: |
          echo Looking for vcpkg msys2 root
          set MSYS2_ROOT=%VCPKG_DIR%\downloads\tools\msys2
          for /f "delims=" %%i in ('dir /b /ad "%MSYS2_ROOT%" 2^>nul') do set MSYS2_DIR=%%i
          if not defined MSYS2_DIR (
            echo msys2 root not present yet, skipping pacman step
          ) else (
            set MSYS2_PATH=%MSYS2_ROOT%\%MSYS2_DIR%
            echo msys path: %MSYS2_PATH%
            %MSYS2_PATH%\usr\bin\bash.exe -lc "pacman -Sy --noconfirm mingw-w64-x86_64-pkgconf mingw-w64-x86_64-nasm mingw-w64-x86_64-yasm mingw-w64-x86_64-toolchain base-devel perl --needed || true"
          )
        shell: cmd

      - name: Build Static FFmpeg
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        run: |
          echo "Building static FFmpeg..."
          cd build-script
          call build-static-ffmpeg-windows.bat

      - name: Verify vcpkg static libraries (with debug output)
        run: |
          set VCPKG_MAX_CONCURRENCY=%VCPKG_MAX_CONCURRENCY%
          set LIB_DIR=%VCPKG_DIR%\installed\x64-mingw-static\lib
          echo === vcpkg list ===
          if exist "%VCPKG_DIR%\vcpkg.exe" (
            call "%VCPKG_DIR%\vcpkg.exe" list
          ) else (
            echo WARNING: vcpkg.exe not found in %VCPKG_DIR% - skipping vcpkg list
          )
          echo === vcpkg bootstrap/log/version info ===
          if exist "%VCPKG_DIR%\.git" (
            cd "%VCPKG_DIR%" && git rev-parse --short HEAD && git describe --tags --dirty || echo "git info unavailable"
          ) else (
            echo "No git info for vcpkg"
          )
          echo === Directory listing: %LIB_DIR% ===
          if exist "%LIB_DIR%" (
            dir "%LIB_DIR%"
          ) else (
            echo ERROR: Library folder not found: %LIB_DIR% && exit /b 1
          )
          echo All static libraries present.

      - name: Dump ffmpeg buildtrees folder on failure
        if: failure()
        run: |
          echo Dumping full buildtrees directory for ffmpeg
          dir D:\vcpkg\buildtrees\ffmpeg /s
          echo Done dumping

      - name: Build Qt Statically (if not cached) - using external MinGW
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          call build-script/build-static-qt-from-source.bat

      - name: Create Build Directory
        run: |
          mkdir "%RUNNER_TEMP%\build"

      - name: Prepare Driver Files
        run: |
          mkdir "%SOURCE_DIR%\drivers\windows"
          copy "driver\windows\*" "%SOURCE_DIR%\drivers\windows\" /Y

      - name: Update Translations (lupdate + lrelease)
        working-directory: ${{ runner.temp }}\build
        run: |
          set PATH=C:\Qt6\bin;C:\mingw64\bin;%PATH%
          if not exist "C:\Qt6\bin\lupdate.exe" ( echo lupdate not found & exit /b 1 )
          C:\Qt6\bin\lupdate.exe "%SOURCE_DIR%\openterfaceQT.pro"
          C:\Qt6\bin\lrelease.exe "%SOURCE_DIR%\openterfaceQT.pro"

      - name: Build Portable Executable with CMake (run from MSYS2; external MinGW compilers)
        working-directory: ${{ runner.temp }}\build
        run: >-
          REM Run the final cmake build inside MSYS2 to use MSYS2 runtime for packaging while ensuring we use the external MinGW toolchain for compilers
          for /f "delims=" %%i in ('dir /b /ad "C:\msys64\usr" 2^>nul') do set MSYS2_DIR=%%i && set MSYS2_PATH=C:\msys64\usr\bin
          if not exist "%MSYS2_PATH%\bash.exe" (
            set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;%PATH% &&
            cmake -G "Ninja"
              -DCMAKE_BUILD_TYPE=Release
              -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
              -DVCPKG_TARGET_TRIPLET="x64-mingw-static"
              -DCMAKE_PREFIX_PATH="C:/Qt6"
              -DOPENTERFACE_BUILD_STATIC=ON
              -DCMAKE_C_COMPILER="%EXTERNAL_MINGW%/bin/gcc.exe"
              -DCMAKE_CXX_COMPILER="%EXTERNAL_MINGW%/bin/g++.exe"
              -DCMAKE_RC_COMPILER="%EXTERNAL_MINGW%/bin/windres.exe"
              "%SOURCE_DIR%" &&
            cmake --build . --config Release -- -j2 &&
            for /f "delims=" %F in ('dir /s /b openterfaceQT.exe 2^>nul') do set "EXE=%F" &&
            if not defined EXE (
              echo Build failed: openterfaceQT.exe not found && dir /s /b . && exit /b 1
            ) &&
            echo Checking for DLL dependencies... &&
            %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" >nul && (
              echo ERROR: DLL dependencies detected! &&
              %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" &&
              exit /b 1
            ) || (
              echo OK: No DLL dependencies — fully static.
            ) &&
            %EXTERNAL_MINGW%\bin\strip.exe -s "%EXE%" &&
            mkdir package &&
            copy "%EXE%" package\openterfaceQT-portable.exe
          ) else (
            # Quote the cygpath converted SOURCE_DIR to avoid splitting on spaces
            "%MSYS2_PATH%\bash.exe" -lc "export PATH=/c/Qt6/bin:/c/mingw64/bin:$PATH && cmake -G \"Ninja\" -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=\"/c/vcpkg/scripts/buildsystems/vcpkg.cmake\" -DVCPKG_TARGET_TRIPLET=\"x64-mingw-static\" -DCMAKE_PREFIX_PATH=\"/c/Qt6\" -DOPENTERFACE_BUILD_STATIC=ON -DCMAKE_C_COMPILER=/c/mingw64/bin/gcc.exe -DCMAKE_CXX_COMPILER=/c/mingw64/bin/g++.exe -DCMAKE_RC_COMPILER=/c/mingw64/bin/windres.exe \"$(cygpath -u '%SOURCE_DIR%')\" && cmake --build . --config Release -- -j2 || exit 1"
            "%MSYS2_PATH%\bash.exe" -lc "for f in \$(find . -name \"openterfaceQT.exe\" -print -quit); do EXE=\$f; break; done; if [ -z \"\$EXE\" ]; then echo Build failed: openterfaceQT.exe not found && exit 1; fi; /c/mingw64/bin/objdump -p \"\$EXE\" | grep -i \\\"\\.dll\\\" && (echo ERROR: DLL dependencies detected && /c/mingw64/bin/objdump -p \"\$EXE\" | grep -i \\\"\\.dll\\\" && exit 1) || echo OK: No DLL dependencies; /c/mingw64/bin/strip -s \"\$EXE\"; mkdir -p package; cp \"\$EXE\" package/openterfaceQT-portable.exe"
          )
            -DCMAKE_BUILD_TYPE=Release
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
            -DVCPKG_TARGET_TRIPLET="x64-mingw-static"
            -DCMAKE_PREFIX_PATH="C:/Qt6"
            -DOPENTERFACE_BUILD_STATIC=ON
            -DCMAKE_C_COMPILER="%EXTERNAL_MINGW%/bin/gcc.exe"
            -DCMAKE_CXX_COMPILER="%EXTERNAL_MINGW%/bin/g++.exe"
            -DCMAKE_RC_COMPILER="%EXTERNAL_MINGW%/bin/windres.exe"
            "%SOURCE_DIR%" &&
          cmake --build . --config Release -- -j2 &&
          for /f "delims=" %F in ('dir /s /b openterfaceQT.exe 2^>nul') do set "EXE=%F" &&
          if not defined EXE (
            echo Build failed: openterfaceQT.exe not found && dir /s /b . && exit /b 1
          ) &&
          echo Checking for DLL dependencies... &&
          %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" >nul && (
            echo ERROR: DLL dependencies detected! &&
            %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" &&
            exit /b 1
          ) || (
            echo OK: No DLL dependencies — fully static.
          ) &&
          %EXTERNAL_MINGW%\bin\strip.exe -s "%EXE%" &&
          mkdir package &&
          copy "%EXE%" package\openterfaceQT-portable.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}\build\package\openterfaceQT-portable.exe
          if-no-files-found: error