name: Portable Build for windows

on:
  push:
    branches: ["main", "dev_20250611_add_vertical_screen_operate"]
  pull_request:
    branches: ["dev"]
  workflow_dispatch:

defaults:
  run:
    shell: cmd

env:
  ARTIFACT: openterfaceQT.windows.amd64.portable.exe
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 6.5.3 
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  ORGANIZATION_NAME: "TechxArtisan"
  VCPKG_DIR: C:\vcpkg
  OPENSSL_DIR: C:\vcpkg\installed\x64-mingw-static
  MSYS2_DIR: C:\msys64
  EXTERNAL_MINGW: C:\mingw64
  FFMPEG_INSTALL_PREFIX: C:\ffmpeg-static

jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Cache Qt Build
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: C:\Qt6
          key: qt-6.5.3-mingw-windows-static-openssl
          restore-keys: |
            qt-6.5.3-mingw-windows-static-openssl

      - name: Cache MinGW and Ninja Build
        id: cache-mingw
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.EXTERNAL_MINGW }}
            C:\ProgramData\chocolatey\lib\ninja
          key: mingw-ninja-windows-static
          restore-keys: |
            mingw-ninja-windows-static

      - name: Cache vcpkg
        id: cache-vcpkg
        uses: actions/cache@v3
        with:
          path: C:\vcpkg
          key: vcpkg-mingw-static-openssl-v2
          restore-keys: |
            vcpkg-mingw-static-openssl-v2

      - name: Cache FFmpeg build
        id: cache-ffmpeg
        uses: actions/cache@v3
        with:
          path: C:\ffmpeg-static
          key: ffmpeg-static-6.1.1
          restore-keys: |
            ffmpeg-static-6.1.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Build environment
        if: steps.cache-mingw.outputs.cache-hit != 'true'
        run: |
          echo "Installing Ninja"
          choco install ninja -y
    
          echo "Downloading pre-compiled static build of MinGW-w64"
          curl -L -o mingw-w64.zip https://sourceforge.net/projects/mingw-w64/files/latest/download
          mkdir %EXTERNAL_MINGW%
          tar -xf mingw-w64.zip -C %EXTERNAL_MINGW% --strip-components=1
    
          echo "Setting up PATH for MinGW-w64"
          set PATH=%EXTERNAL_MINGW%\bin;%PATH%
          g++ --version || (echo "g++ installation failed. Please check the installation." && exit 1)

      - name: Install MSYS2 (for dependency management)
        id: install-msys2
        run: |
          echo "Installing MSYS2 via Chocolatey"
          choco install msys2 -y || echo "msys2 may already be installed"
          echo "Updating PATH for MSYS2..."
          set PATH=%MSYS2_DIR%\usr\bin;%PATH%
          echo "Updating MSYS2 packages and installing essential build packages"
          %MSYS2_DIR%\usr\bin\bash.exe -lc "pacman -Sy --noconfirm && pacman -S --noconfirm --needed base-devel pkg-config git make yasm nasm mingw-w64-x86_64-make mingw-w64-x86_64-pkg-config mingw-w64-x86_64-libiconv mingw-w64-x86_64-cmake mingw-w64-x86_64-libmfx mingw-w64-x86_64-bzip2 mingw-w64-x86_64-xz mingw-w64-x86_64-winpthreads"

      - name: Install vcpkg and OpenSSL
        if: steps.cache-vcpkg.outputs.cache-hit != 'true'
        run: |
          echo "Installing vcpkg"
          if not exist "%VCPKG_DIR%" (
            git clone https://github.com/microsoft/vcpkg.git %VCPKG_DIR%
            cd %VCPKG_DIR%
            call bootstrap-vcpkg.bat
          )
          echo "Installing OpenSSL static libraries"
          %VCPKG_DIR%\vcpkg update
          %VCPKG_DIR%\vcpkg install openssl:x64-mingw-static zlib:x64-mingw-static --triplet x64-mingw-static --host-triplet x64-mingw-static --clean-after-build
          %VCPKG_DIR%\vcpkg integrate install

      - name: check OpenSSL installation
        run: |
          echo "Verifying OpenSSL installation..."
          dir %OPENSSL_DIR%\lib
          if not exist "%OPENSSL_DIR%\lib\libssl.a" (
            echo "Error: libssl.a not found. OpenSSL static libraries not properly installed."
            exit 1
          )
          if not exist "%OPENSSL_DIR%\lib\libcrypto.a" (
            echo "Error: libcrypto.a not found. OpenSSL static libraries not properly installed."
            exit 1
          )
          echo "OpenSSL static libraries verified successfully!"
          
          echo "Checking library architecture..."
          file "%OPENSSL_DIR%\lib\libssl.a" || echo "file command not available"
          echo "SSL library size:" && dir "%OPENSSL_DIR%\lib\libssl.a" | findstr "libssl.a"
          echo "Crypto library size:" && dir "%OPENSSL_DIR%\lib\libcrypto.a" | findstr "libcrypto.a"

      - name: Build Qt Statically
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          echo "Setting PATH to use external MinGW: %EXTERNAL_MINGW%"
          set PATH=%EXTERNAL_MINGW%\bin;%PATH%
          call build-script/build-static-qt-from-source.bat

      - name: Build FFmpeg (static) with external MinGW
        if: steps.cache-ffmpeg.outputs.cache-hit != 'true'
        # Build FFmpeg as part of the workflow; use MSYS2 to handle dependencies and external MinGW for compile
        run: |
          echo "Preparing to build FFmpeg statically using external MinGW and MSYS2 for handling dependencies"
          set MSYS2_ROOT=%MSYS2_DIR%
          REM ensure EXTERNAL_MINGW value from job environment is used; no need to override
          set EXTERNAL_MINGW=%EXTERNAL_MINGW%
          set FFMPEG_INSTALL_PREFIX=%FFMPEG_INSTALL_PREFIX%
          set PATH=%MSYS2_DIR%\usr\bin;%EXTERNAL_MINGW%\bin;%PATH%
          echo "Verifying msys2 bash and external mingw versions"
          C:\msys64\usr\bin\bash.exe -lc "gcc --version || echo 'MSYS2 gcc not present or ignored'"
          echo "Running build script for ffmpeg"
          call build-script\build-static-ffmpeg-windows.bat

      - name: Verify FFmpeg build output
        run: |
          echo "Checking FFmpeg install prefix: %FFMPEG_INSTALL_PREFIX%"
          if not exist "%FFMPEG_INSTALL_PREFIX%\lib\libavcodec.a" (
            echo "Error: FFmpeg build failed or libavcodec.a not found"
            dir %FFMPEG_INSTALL_PREFIX%\lib
            exit 1
          )
          echo "FFmpeg libraries found in %FFMPEG_INSTALL_PREFIX%\lib"

      - name: Create build directory
        run: |
          mkdir ${{ runner.temp }}\build
          
      - name: Prepare .pro File for Static Build
        run: |
          echo "Preparing static build configuration..."
          if not exist "${{ env.SOURCE_DIR }}\openterfaceQT.pro" (
            echo "Error: .pro file not found."
            exit 1
          )
          
          echo "Creating static build configuration file..."
          echo "# Static build configuration for GitHub Actions" > "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "CONFIG += static staticlib release" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "# OpenSSL static linking configuration" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "INCLUDEPATH += %OPENSSL_DIR%\include" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "# Static linking flags" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "QMAKE_CXXFLAGS += -static -static-libgcc -static-libstdc++ -I%OPENSSL_DIR%\include" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "QMAKE_LFLAGS += -static -static-libgcc -static-libstdc++" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "# OpenSSL static libraries (order matters)" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %OPENSSL_DIR%\lib\libssl.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %OPENSSL_DIR%\lib\libcrypto.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += -lws2_32 -lcrypt32 -ladvapi32 -luser32" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "# Windows subsystem" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "QMAKE_LFLAGS += -Wl,-subsystem,windows" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          
          echo "Adding include to main .pro file..."
          echo "" >> "${{ env.SOURCE_DIR }}\openterfaceQT.pro"
          echo "include(static_build.pri)" >> "${{ env.SOURCE_DIR }}\openterfaceQT.pro"

          echo "# FFmpeg static libraries and include path" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "INCLUDEPATH += %FFMPEG_INSTALL_PREFIX%\include" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %FFMPEG_INSTALL_PREFIX%\lib\libavcodec.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %FFMPEG_INSTALL_PREFIX%\lib\libavformat.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %FFMPEG_INSTALL_PREFIX%\lib\libavutil.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %FFMPEG_INSTALL_PREFIX%\lib\libswresample.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"
          echo "LIBS += %FFMPEG_INSTALL_PREFIX%\lib\libswscale.a" >> "${{ env.SOURCE_DIR }}\static_build.pri"

      - name: Prepare Driver Files
        run: |
          mkdir ${{ env.SOURCE_DIR }}\drivers
          mkdir ${{ env.SOURCE_DIR }}\drivers\windows
          copy driver\windows\* ${{ env.SOURCE_DIR }}\drivers\windows

      - name: Update and Release Translations
        working-directory: ${{ runner.temp }}\build
        run: |
          echo "Setting up Qt tools path..."
          set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;%PATH%
          echo "Verifying Qt tools..."
          if not exist "C:\Qt6\bin\lupdate.exe" (
            echo "Error: lupdate.exe not found in C:\Qt6\bin"
            exit 1
          )
          echo "Running lupdate..."
          C:\Qt6\bin\lupdate.exe "${{ env.SOURCE_DIR }}\openterfaceQT.pro" || (echo "lupdate failed" && exit 1)
          echo "Running lrelease..."
          C:\Qt6\bin\lrelease.exe "${{ env.SOURCE_DIR }}\openterfaceQT.pro" || (echo "lrelease failed" && exit 1)

      - name: Build Portable Executable
        working-directory: ${{ runner.temp }}\build
        run: |
          echo "Setting up build environment..."
          set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;%PATH%
          set INCLUDE=C:\Qt6\include;%OPENSSL_DIR%\include;%FFMPEG_INSTALL_PREFIX%\include;%INCLUDE%
          set LIB=%FFMPEG_INSTALL_PREFIX%\lib;%OPENSSL_DIR%\lib;%LIB%
          
          echo "Verifying OpenSSL libraries..."
          if not exist "%OPENSSL_DIR%\lib\libssl.a" (
            echo "Error: libssl.a not found at %OPENSSL_DIR%\lib\libssl.a"
            exit 1
          )
          if not exist "%OPENSSL_DIR%\lib\libcrypto.a" (
            echo "Error: libcrypto.a not found at %OPENSSL_DIR%\lib\libcrypto.a"
            exit 1
          )
          
          echo "Checking Qt configuration..."
          C:\Qt6\bin\qmake -query
          
          echo "Building with qmake..."
          qmake -r "${{ env.SOURCE_DIR }}\openterfaceQT.pro" CONFIG+=release || (echo "qmake failed. Please check the .pro file and paths." && exit 1)
          
          echo "Building with mingw32-make..."
          set MINGW_STATIC_BUILD=1
          mingw32-make VERBOSE=1 -j2 || (echo "mingw32-make failed. Please check the build configuration." && exit 1)
          set ERRORLEVEL=0
          
          if not exist release\openterfaceQT.exe (
            echo "Error: Failed to build openterfaceQT.exe"
            exit 1
          )
        
          echo "Verifying executable dependencies..."
          echo "Checking if the executable is truly static..."
          objdump -p release\openterfaceQT.exe | findstr -i "dll" || echo "No external DLL dependencies found (good for static build)"
        
          echo "Stripping debug symbols from executable..."
          strip -s release\openterfaceQT.exe || (echo "Failed to strip debug symbols" && exit 1)
          
          echo "Creating portable package..."
          mkdir package
          copy release\openterfaceQT.exe package\openterfaceQT-portable.exe

      - name: Save build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}\build\package\openterfaceQT-portable.exe
          if-no-files-found: error