name: Portable Build for Windows (CMake + vcpkg + MinGW Static)

on:
  push:
    branches: ["main", "dev_20250611_add_vertical_screen_operate"]
  pull_request:
    branches: ["dev"]
  workflow_dispatch:

defaults:
  run:
    shell: cmd

env:
  ARTIFACT: openterfaceQT.windows.amd64.portable.exe
  SOURCE_DIR: ${{ github.workspace }}
  QT_VERSION: 6.5.3
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  VCPKG_DIR: C:\vcpkg
  EXTERNAL_MINGW: C:\mingw64

jobs:
  build:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Qt Build
        id: cache-qt
        uses: actions/cache@v3
        with:
          path: C:\Qt6
          key: qt-6.5.3-mingw-windows-static-vcpkg
          restore-keys: |
            qt-6.5.3-mingw-windows-static-

      - name: Cache MinGW and Ninja
        id: cache-mingw
        uses: actions/cache@v3
        with:
          path: |
            C:\mingw64
            C:\ProgramData\chocolatey\lib\ninja
          key: mingw-ninja-static-2025
          restore-keys: |
            mingw-ninja-static-

      - name: Cache vcpkg
        id: cache-vcpkg
        uses: actions/cache@v3
        with:
          path: C:\vcpkg
          key: vcpkg-x64-mingw-static-openssl-ffmpeg-zlib-v1
          restore-keys: |
            vcpkg-x64-mingw-static-

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Ninja and MinGW (if not cached)
        if: steps.cache-mingw.outputs.cache-hit != 'true'
        run: |
          echo Installing Ninja...
          choco install ninja -y

          echo Downloading MinGW-w64 static build...
          curl -L -o mingw-w64.zip https://github.com/niXman/mingw-builds-binaries/releases/download/13.2.0-rt_v11-rev1/x86_64-13.2.0-release-win32-seh-ucrt-rt_v11-rev1.7z
          mkdir C:\mingw64_tmp
          7z x mingw-w64.zip -oC:\mingw64_tmp
          move C:\mingw64_tmp\x86_64-13.2.0-release-win32-seh-ucrt-rt_v11-rev1\* C:\mingw64\
          rmdir /s /q C:\mingw64_tmp

          echo Verifying g++...
          set PATH=C:\mingw64\bin;%PATH%
          g++ --version

      - name: Install vcpkg and static libraries (OpenSSL, FFmpeg, zlib)
        run: |
          echo Cloning or updating vcpkg...
          if not exist "%VCPKG_DIR%\vcpkg.exe" (
            echo "vcpkg.exe not found, cloning vcpkg repo..."
            git clone https://github.com/microsoft/vcpkg.git %VCPKG_DIR%
            cd %VCPKG_DIR%
            call bootstrap-vcpkg.bat
          ) else (
            echo "%VCPKG_DIR%\vcpkg.exe already exists, updating vcpkg repo"
            cd %VCPKG_DIR%
            git fetch --all || echo "git fetch failed"
            git reset --hard origin/master || echo "git reset failed"
            call bootstrap-vcpkg.bat
          )

          cd "%SOURCE_DIR%"

          echo Installing static packages via manifest (vcpkg.json)...
          call "%VCPKG_DIR%\vcpkg.exe" install ^
            --triplet=x64-mingw-static ^
            --host-triplet=x64-mingw-static ^
            --clean-after-build
          
          call "%VCPKG_DIR%\vcpkg.exe" integrate install

      - name: Verify vcpkg static libraries (with debug output)
        run: |
          set LIB_DIR=%VCPKG_DIR%\installed\x64-mingw-static\lib
          echo === vcpkg list ===
          if exist "%VCPKG_DIR%\vcpkg.exe" (
            call "%VCPKG_DIR%\vcpkg.exe" list
          ) else (
            echo WARNING: vcpkg.exe not found in %VCPKG_DIR% - skipping vcpkg list
          )
          echo === Directory listing: %LIB_DIR% ===
          if exist "%LIB_DIR%" (
            dir "%LIB_DIR%"
          ) else (
            echo ERROR: Library folder not found: %LIB_DIR% && exit /b 1
          )

          REM Check for both .a and .lib variants in the installed folder to be robust
          if not exist "%LIB_DIR%\libssl.a" if not exist "%LIB_DIR%\libssl.lib" (
            echo ERROR: libssl missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libcrypto.a" if not exist "%LIB_DIR%\libcrypto.lib" (
            echo ERROR: libcrypto missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libavcodec.a" if not exist "%LIB_DIR%\avcodec.lib" (
            echo ERROR: libavcodec missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libavformat.a" if not exist "%LIB_DIR%\avformat.lib" (
            echo ERROR: libavformat missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libavutil.a" if not exist "%LIB_DIR%\avutil.lib" (
            echo ERROR: libavutil missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libswscale.a" if not exist "%LIB_DIR%\swscale.lib" (
            echo ERROR: libswscale missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          if not exist "%LIB_DIR%\libz.a" if not exist "%LIB_DIR%\zlib.lib" (
            echo ERROR: libz (zlib) missing in %LIB_DIR% && dir "%LIB_DIR%" && exit /b 1
          )
          echo All static libraries present.

      - name: Build Qt Statically (if not cached)
        if: steps.cache-qt.outputs.cache-hit != 'true'
        run: |
          call build-script/build-static-qt-from-source.bat

      - name: Create Build Directory
        run: |
          mkdir "%RUNNER_TEMP%\build"

      - name: Prepare Driver Files
        run: |
          mkdir "%SOURCE_DIR%\drivers\windows"
          copy "driver\windows\*" "%SOURCE_DIR%\drivers\windows\" /Y

      - name: Update Translations (lupdate + lrelease)
        working-directory: ${{ runner.temp }}\build
        run: |
          set PATH=C:\Qt6\bin;C:\mingw64\bin;%PATH%
          if not exist "C:\Qt6\bin\lupdate.exe" ( echo lupdate not found & exit /b 1 )
          C:\Qt6\bin\lupdate.exe "%SOURCE_DIR%\openterfaceQT.pro"
          C:\Qt6\bin\lrelease.exe "%SOURCE_DIR%\openterfaceQT.pro"

      - name: Build Portable Executable with CMake
        working-directory: ${{ runner.temp }}\build
        run: >-
          set PATH=C:\Qt6\bin;%EXTERNAL_MINGW%\bin;%PATH% &&
          cmake -G "Ninja"
            -DCMAKE_BUILD_TYPE=Release
            -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake"
            -DVCPKG_TARGET_TRIPLET="x64-mingw-static"
            -DCMAKE_PREFIX_PATH="C:/Qt6"
            -DOPENTERFACE_BUILD_STATIC=ON
            -DCMAKE_C_COMPILER="%EXTERNAL_MINGW%/bin/gcc.exe"
            -DCMAKE_CXX_COMPILER="%EXTERNAL_MINGW%/bin/g++.exe"
            -DCMAKE_RC_COMPILER="%EXTERNAL_MINGW%/bin/windres.exe"
            "%SOURCE_DIR%" &&
          cmake --build . --config Release -- -j2 &&
          for /f "delims=" %F in ('dir /s /b openterfaceQT.exe 2^>nul') do set "EXE=%F" &&
          if not defined EXE (
            echo Build failed: openterfaceQT.exe not found && dir /s /b . && exit /b 1
          ) &&
          echo Checking for DLL dependencies... &&
          %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" >nul && (
            echo ERROR: DLL dependencies detected! &&
            %EXTERNAL_MINGW%\bin\objdump.exe -p "%EXE%" | findstr /i "\.dll" &&
            exit /b 1
          ) || (
            echo OK: No DLL dependencies â€” fully static.
          ) &&
          %EXTERNAL_MINGW%\bin\strip.exe -s "%EXE%" &&
          mkdir package &&
          copy "%EXE%" package\openterfaceQT-portable.exe

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT }}
          path: ${{ runner.temp }}\build\package\openterfaceQT-portable.exe
          if-no-files-found: error