name: Docker cross-build FFmpeg (Windows static)

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]

jobs:
  build-and-push-ffmpeg:
    runs-on: ubuntu-latest
    env:
      FFMPEG_VERSION: 6.1.1
      IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/openterface-ffmpeg-win-static:${{ env.FFMPEG_VERSION }}
      LOCAL_TAG: openterface/ffmpeg-win-static:${{ env.FFMPEG_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image exists on GHCR
        id: check_image
        run: |
          echo "Checking for ${IMAGE_NAME} on GHCR..."
          if docker pull ${IMAGE_NAME}; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Use existing image and export artifacts
        if: steps.check_image.outputs.exists == 'true'
        run: |
          echo "Image exists on GHCR, extracting artifacts"
          docker tag ${IMAGE_NAME} ${LOCAL_TAG} || true
          CID=$(docker create ${IMAGE_NAME})
          mkdir -p $GITHUB_WORKSPACE/build/ffmpeg-win-static
          docker cp $CID:/opt/ffmpeg-win-static $GITHUB_WORKSPACE/build/ffmpeg-win-static || echo "No /opt/ffmpeg-win-static found in the image"
          docker rm $CID

      - name: Build docker image (ffmpeg) and push to GHCR
        if: steps.check_image.outputs.exists == 'false'
        run: |
          docker build -f docker/Dockerfile.ffmpeg-windows-static -t ${LOCAL_TAG} --build-arg FFMPEG_VERSION=${FFMPEG_VERSION} .
          docker tag ${LOCAL_TAG} ${IMAGE_NAME}
          docker push ${IMAGE_NAME}
          # export artifacts
          CID=$(docker create ${IMAGE_NAME})
          mkdir -p $GITHUB_WORKSPACE/build/ffmpeg-win-static
          docker cp $CID:/opt/ffmpeg-win-static $GITHUB_WORKSPACE/build/ffmpeg-win-static || echo "No /opt/ffmpeg-win-static found in the image"
          docker rm $CID

      - name: Upload static ffmpeg artifact
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-win-static
          path: build/ffmpeg-win-static
