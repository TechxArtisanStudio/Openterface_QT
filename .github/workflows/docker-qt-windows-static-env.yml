name: Docker cross-build Qt (Windows static env)

permissions:
  contents: read
  packages: write

on:
  workflow_dispatch:
  push:
    branches: [ main, dev ]

jobs:
  build-qt-win-static:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare image names
        run: |
          echo "FFMPEG_VERSION=6.1.1" >> $GITHUB_ENV
          echo "QT_VERSION=6.6.3" >> $GITHUB_ENV
          echo "FFMPEG_GHCR=ghcr.io/${{ github.repository_owner }}/openterface-ffmpeg-win-static:${{ env.FFMPEG_VERSION }}" >> $GITHUB_ENV
          echo "FFMPEG_LOCAL=openterface/ffmpeg-win-static:${{ env.FFMPEG_VERSION }}" >> $GITHUB_ENV
          echo "QT_GHCR=ghcr.io/${{ github.repository_owner }}/openterface-qt-win-static:${{ env.QT_VERSION }}-ffmpeg${{ env.FFMPEG_VERSION }}" >> $GITHUB_ENV
          echo "QT_LOCAL=openterface/qt-win-static:${{ env.QT_VERSION }}-ffmpeg${{ env.FFMPEG_VERSION }}" >> $GITHUB_ENV

      - name: Check / pull ffmpeg image from GHCR or build and push
        id: ffmpeg_check
        run: |
          echo "Checking for ${FFMPEG_GHCR}..."
          if docker pull ${FFMPEG_GHCR}; then
            echo "exists=true" >> $GITHUB_OUTPUT
            docker tag ${FFMPEG_GHCR} ${FFMPEG_LOCAL} || true
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Building local ffmpeg image and pushing to GHCR"
            docker build -f docker/Dockerfile.ffmpeg-windows-static -t ${FFMPEG_LOCAL} --build-arg FFMPEG_VERSION=${FFMPEG_VERSION} .
            docker tag ${FFMPEG_LOCAL} ${FFMPEG_GHCR}
            docker push ${FFMPEG_GHCR}
          fi

      - name: Check if Qt image exists on GHCR
        id: qt_check
        run: |
          echo "Checking for ${QT_GHCR} on GHCR..."
          if docker pull ${QT_GHCR}; then
            echo "exists=true" >> $GITHUB_OUTPUT
            docker tag ${QT_GHCR} ${QT_LOCAL} || true
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build Qt cross-image (if missing) and push to GHCR
        if: steps.qt_check.outputs.exists == 'false'
        run: |
          docker build -f docker/Dockerfile.qt-windows-static -t ${QT_LOCAL} --build-arg BASE_IMAGE=${FFMPEG_GHCR} --build-arg QT_VERSION=${QT_VERSION} .
          docker tag ${QT_LOCAL} ${QT_GHCR}
          docker push ${QT_GHCR}

      - name: Try extracting /opt/qt-windows-static (may be empty if Qt not fully built)
        run: |
          CID=$(docker create ${QT_GHCR}) && \
          mkdir -p $GITHUB_WORKSPACE/build/qt-win-static && \
          docker cp $CID:/opt/qt-windows-static $GITHUB_WORKSPACE/build/qt-win-static || echo "No Qt prefix yet" && \
          docker rm $CID

      - name: Upload Qt prefix (if exists)
        uses: actions/upload-artifact@v4
        with:
          name: qt-win-static
          path: build/qt-win-static
