Name:           openterfaceqt
Version:        ${VERSION}
Release:        1
Summary:        OpenterfaceQT KVM Linux Application

License:        AGPL-3.0
URL:           https://github.com/TechxArtisanStudio/Openterface_QT

# Disable automatic dependency detection since we bundle most libraries
AutoReqProv: no

# System-level dependencies only - Qt, FFmpeg and plugins are bundled in /usr/lib/openterfaceqt/
# All libraries including libusb are bundled with the application

%description
OpenterfaceQT Application with bundled Qt6 and FFmpeg libraries

%prep
# Build system provides staged files in %{_sourcedir}
# No extraction needed - build script handles preparation

%install
# Create necessary directories
mkdir -p %{buildroot}/usr/bin
mkdir -p %{buildroot}/usr/lib/openterfaceqt
mkdir -p %{buildroot}/usr/lib/qt6/plugins
mkdir -p %{buildroot}/usr/lib/qt6/qml
mkdir -p %{buildroot}/usr/share/applications
mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps

# Install main binary
cp -r %{_sourcedir}/openterfaceQT %{buildroot}/usr/bin/

# Install bundled libraries into isolated directory
# These prevent conflicts with system-installed versions
echo "Installing bundled libraries to /usr/lib/openterfaceqt/"

# Qt6 core libraries
cp %{_sourcedir}/libQt6*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# Image processing libraries
cp %{_sourcedir}/libjpeg*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libturbojpeg*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# USB libraries
cp %{_sourcedir}/libusb*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# Compression libraries (if bundled)
cp %{_sourcedir}/libbz2*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libz*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# Hardware acceleration libraries
cp %{_sourcedir}/libva*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# Multimedia libraries
cp %{_sourcedir}/libgstreamer*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libv4l*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# FFmpeg core libraries (all components needed for video processing)
cp %{_sourcedir}/libavdevice*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavcodec*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavformat*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavutil*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libswscale*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libswresample*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavfilter*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true

# Qt plugins and QML modules (optional but recommended)
cp -r %{_sourcedir}/qt6-plugins/* %{buildroot}/usr/lib/qt6/plugins/ 2>/dev/null || true
cp -r %{_sourcedir}/qt6-qml/* %{buildroot}/usr/lib/qt6/qml/ 2>/dev/null || true

# Install application icon if present
[ -f %{_sourcedir}/icon_256.png ] && cp %{_sourcedir}/icon_256.png %{buildroot}/usr/share/icons/hicolor/256x256/apps/openterfaceQT.png || true

# Create desktop entry with environment variables for bundled libraries
cat > %{buildroot}/usr/share/applications/openterfaceQT.desktop << EOF
[Desktop Entry]
Version=${VERSION}
Type=Application
Name=OpenterfaceQT
Exec=env QT_PLUGIN_PATH=/usr/lib/qt6/plugins QML2_IMPORT_PATH=/usr/lib/qt6/qml /usr/bin/openterfaceQT
Icon=openterfaceQT
Comment=OpenterfaceQT KVM Application
Categories=Utility;
EOF

# Generate dynamic file list to handle optional files gracefully
find %{buildroot} -type f -o -type l | sed 's|%{buildroot}||' > %{_builddir}/../FILELIST.txt

%files -f %{_builddir}/../FILELIST.txt

%post
# Register bundled libraries with system linker during installation
# This allows the binary to find bundled FFmpeg and Qt libraries without conflicts
mkdir -p /etc/ld.so.conf.d

cat > /etc/ld.so.conf.d/openterface-libs.conf <<'EOF'
# OpenterfaceQT bundled libraries (isolated from system libraries)
# This directory contains a complete set of FFmpeg, Qt6, and multimedia libraries
/usr/lib/openterfaceqt
EOF

# Clean up library structure: remove intermediate .so.X files and keep only proper chains
# This prevents ldconfig warnings about non-symlink libraries
if [ -d /usr/lib/openterfaceqt ]; then
    cd /usr/lib/openterfaceqt
    
    # Find all library files and organize them properly
    for fullfile in *.so.*.* ; do
        [ -f "$fullfile" ] || continue
        
        # Extract library name and version info
        # e.g., libQt6Core.so.6.6.3 -> base=libQt6Core, major=6, full=6.6.3
        base=$(echo "$fullfile" | sed 's/\.so\..*//')
        soname=$(echo "$fullfile" | sed 's/\(.*\.so\.[0-9]*\).*/\1/')
        
        # Create major version symlink if needed: libQt6Core.so.6 -> libQt6Core.so.6.6.3
        if [ "$soname" != "$fullfile" ] && [ ! -L "$soname" ] && [ ! -f "$soname" ]; then
            ln -sf "$fullfile" "$soname" 2>/dev/null || true
        fi
        
        # Create base .so symlink if needed: libQt6Core.so -> libQt6Core.so.6
        if [ ! -L "$base.so" ] && [ ! -f "$base.so" ]; then
            ln -sf "$soname" "$base.so" 2>/dev/null || true
        fi
    done
    
    # Remove any non-symlink .so.X files (keep only symlinks or .so.X.X.X)
    for soXfile in *.so.[0-9] ; do
        [ -L "$soXfile" ] && continue  # Skip if it's already a symlink
        [ -f "$soXfile" ] || continue  # Skip if it doesn't exist
        
        # Check if this is a duplicate of a .so.X.X.X file
        base=$(echo "$soXfile" | sed 's/\.so\.[0-9]*$//')
        has_full=$(ls "$base".so.*.*.* 2>/dev/null | wc -l)
        
        if [ $has_full -gt 0 ]; then
            # We have the full version, convert this to a symlink
            fullversion=$(ls "$base".so.*.*.* 2>/dev/null | head -1)
            if [ -n "$fullversion" ]; then
                rm -f "$soXfile"
                ln -sf "$fullversion" "$soXfile" 2>/dev/null || true
            fi
        fi
    done
fi

# Rebuild the dynamic linker cache to register bundled libraries
# Suppress warnings about non-symlink files in bundled scenarios (they're expected)
ldconfig 2>&1 | grep -v "is not a symbolic link" | grep -v "^$" || true

# Verify libraries are registered
echo "OpenterfaceQT libraries registered. Checking library cache..."
ldconfig -p 2>/dev/null | grep openterfaceqt | head -3 || echo "Note: Library check may not be available in all environments"

# Create symlink for binary in /usr/local/bin for consistency with DEB/AppImage installations
# This allows the standard entrypoint script to find the binary without modification
mkdir -p /usr/local/bin
if [ ! -L /usr/local/bin/openterfaceQT ]; then
    ln -sf /usr/bin/openterfaceQT /usr/local/bin/openterfaceQT 2>/dev/null || true
fi

%postun
# Remove ldconfig configuration on uninstall to clean up bundled library paths
if [ $1 -eq 0 ]; then
    rm -f /etc/ld.so.conf.d/openterface-libs.conf
    ldconfig
    echo "OpenterfaceQT library configuration removed"
fi

%changelog
* Tue Mar 19 2024 Your Name <support@techxartisan.com> - ${VERSION}-1
- Initial RPM release