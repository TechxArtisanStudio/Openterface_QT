Name:           openterfaceqt
Version:        ${VERSION}
Release:        1
Summary:        OpenterfaceQT KVM Linux Application

License:        AGPL-3.0
URL:           https://github.com/TechxArtisanStudio/Openterface_QT

# Bundled Qt, no external Qt dependencies
Requires: libusb, libturbojpeg, libva, gstreamer1, gstreamer1-plugins-base, libv4l, libavdevice, libavformat, libavcodec, libswresample, libswscale, libavutil, libavfilter

%description
OpenterfaceQT Application

%prep
# Create a list of files that should be included
# This allows us to handle optional files gracefully

%install
mkdir -p %{buildroot}/usr/bin
mkdir -p %{buildroot}/usr/lib/openterfaceqt
mkdir -p %{buildroot}/usr/lib/qt6/plugins
mkdir -p %{buildroot}/usr/lib/qt6/qml
mkdir -p %{buildroot}/usr/share/applications
mkdir -p %{buildroot}/usr/share/icons/hicolor/256x256/apps

cp -r %{_sourcedir}/openterfaceQT %{buildroot}/usr/bin/
# Copy Qt libraries (required)
cp %{_sourcedir}/libQt6*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
# Copy optional JPEG and VA-API libraries
cp %{_sourcedir}/libjpeg*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libturbojpeg*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libva*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libgstreamer*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libv4l*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
# Copy FFmpeg core libraries
cp %{_sourcedir}/libavdevice*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavcodec*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavformat*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavutil*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libswscale*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libswresample*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
cp %{_sourcedir}/libavfilter*.so* %{buildroot}/usr/lib/openterfaceqt/ 2>/dev/null || true
# Copy Qt plugins and QML
cp -r %{_sourcedir}/qt6-plugins/* %{buildroot}/usr/lib/qt6/plugins/ 2>/dev/null || true
cp -r %{_sourcedir}/qt6-qml/* %{buildroot}/usr/lib/qt6/qml/ 2>/dev/null || true
# Copy icon if present
[ -f %{_sourcedir}/icon_256.png ] && cp %{_sourcedir}/icon_256.png %{buildroot}/usr/share/icons/hicolor/256x256/apps/openterfaceQT.png || true

cat > %{buildroot}/usr/share/applications/openterfaceQT.desktop << EOF
[Desktop Entry]
Version=${VERSION}
Type=Application
Name=OpenterfaceQT
Exec=env QT_PLUGIN_PATH=/usr/lib/qt6/plugins QML2_IMPORT_PATH=/usr/lib/qt6/qml /usr/bin/openterfaceQT
Icon=openterfaceQT
Comment=OpenterfaceQT Application
Categories=Utility;
EOF

# Generate the file list dynamically to handle missing files
find %{buildroot} -type f -o -type l | sed 's|%{buildroot}||' > %{_builddir}/../FILELIST.txt

%files -f %{_builddir}/../FILELIST.txt

%post
# Register bundled libraries with system linker
cat > /etc/ld.so.conf.d/openterface-libs.conf <<'EOF'
# OpenterfaceQT bundled libraries (isolated from system libraries)
/usr/lib/openterfaceqt
EOF
ldconfig

%postun
# Remove ldconfig configuration on uninstall
if [ $1 -eq 0 ]; then
    rm -f /etc/ld.so.conf.d/openterface-libs.conf
    ldconfig
fi

%changelog
* Tue Mar 19 2024 Your Name <support@techxartisan.com> - ${VERSION}-1
- Initial RPM release