#!/bin/bash
# =============================================================================
# OpenterfaceQT Pre-Installation Script
# =============================================================================
#
# This script runs BEFORE the DEB package is unpacked and installed.
# It checks that all required runtime dependencies are already installed.
#
# IMPORTANT: Dependencies must be installed BEFORE running this script.
# When using "dpkg -i", the dpkg lock prevents apt-get from running in preinst.
# Dependencies must be pre-installed by the calling script/installer.
#
# Required dependencies:
#   - Graphics: libegl1, libgles2
#   - Audio: libpulse0
#   - Video: libgstreamer1.0-0, libv4l-0
#   - X11/Display: libxkbcommon0, libwayland-client0, libxcb1, libx11-6
#   - FFmpeg: libavformat60, libavcodec60, libavutil58, libavdevice60
#   - GStreamer Plugins: gstreamer1.0-plugins-base, gstreamer1.0-plugins-good
#   - OpenGL: libgl1, libglx0, libglvnd0, libglu1-mesa
#   - Compression: zlib1g, libbz2-1.0
#
# =============================================================================

echo "=========================================="
echo "OpenterfaceQT Pre-Installation Check"
echo "=========================================="
echo ""

# Function to print status messages
print_status() {
    echo "üì¶ $1"
}

print_success() {
    echo "‚úÖ $1"
}

print_warning() {
    echo "‚ö†Ô∏è  $1"
}

print_error() {
    echo "‚ùå $1"
}

# Check if running with install or upgrade
if [ "$1" != "install" ] && [ "$1" != "upgrade" ]; then
    exit 0
fi

print_status "Checking required dependencies..."
echo ""

# Define dependencies by category
GRAPHICS_DEPS=(
    "libegl1"
    "libgles2"
)

AUDIO_DEPS=(
    "libpulse0"
)

VIDEO_DEPS=(
    "libgstreamer1.0-0"
    "libv4l-0"
)

DISPLAY_DEPS=(
    "libxkbcommon0"
    "libwayland-client0"
    "libxcb1"
    "libx11-6"
)

FFMPEG_DEPS=(
    "libavformat60"
    "libavcodec60"
    "libavutil58"
    "libavdevice60"
)

GSTREAMER_PLUGIN_DEPS=(
    "gstreamer1.0-plugins-base"
    "gstreamer1.0-plugins-good"
)

OPENGL_DEPS=(
    "libgl1"
    "libglx0"
    "libglvnd0"
    "libglu1-mesa"
)

COMPRESSION_DEPS=(
    "zlib1g"
    "libbz2-1.0"
)

# Combine all dependencies into a single array for checking
CRITICAL_DEPS=("${GRAPHICS_DEPS[@]}" "${AUDIO_DEPS[@]}" "${VIDEO_DEPS[@]}" "${DISPLAY_DEPS[@]}" "${FFMPEG_DEPS[@]}" "${GSTREAMER_PLUGIN_DEPS[@]}" "${OPENGL_DEPS[@]}" "${COMPRESSION_DEPS[@]}")

MISSING_DEPS=()
FOUND_DEPS=0

echo "Verifying installed dependencies:"
echo ""

# Helper function to print category header
print_category() {
    local category=$1
    echo "  üì¶ $category:"
}

# Check Graphics dependencies
print_category "Graphics Libraries"
for pkg in "${GRAPHICS_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check Audio dependencies
print_category "Audio Libraries"
for pkg in "${AUDIO_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check Video dependencies
print_category "Video/GStreamer Libraries"
for pkg in "${VIDEO_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check Display dependencies
print_category "X11/Display Server Libraries"
for pkg in "${DISPLAY_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check FFmpeg dependencies
print_category "FFmpeg Libraries"
for pkg in "${FFMPEG_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check GStreamer Plugin dependencies
print_category "GStreamer Plugins"
for pkg in "${GSTREAMER_PLUGIN_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check OpenGL dependencies
print_category "OpenGL Libraries"
for pkg in "${OPENGL_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done
echo ""

# Check Compression dependencies
print_category "Compression Libraries"
for pkg in "${COMPRESSION_DEPS[@]}"; do
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "    ‚úÖ $pkg"
        FOUND_DEPS=$((FOUND_DEPS + 1))
    else
        echo "    ‚ùå $pkg (MISSING)"
        MISSING_DEPS+=("$pkg")
    fi
done

echo ""
echo "=========================================="
echo "Dependency Check Summary"
echo "=========================================="
echo "Found: $FOUND_DEPS/${#CRITICAL_DEPS[@]}"
echo "Missing: ${#MISSING_DEPS[@]}/${#CRITICAL_DEPS[@]}"
echo ""

if [ ${#MISSING_DEPS[@]} -eq 0 ]; then
    print_success "All required dependencies are installed!"
    echo ""
    print_status "Proceeding with OpenterfaceQT package installation..."
    echo ""
    exit 0
else
    print_error "Missing ${#MISSING_DEPS[@]} required dependencies!"
    echo ""
    echo "Missing packages:"
    for pkg in "${MISSING_DEPS[@]}"; do
        echo "  - $pkg"
    done
    echo ""
    echo "=========================================="
    echo "How to install missing dependencies:"
    echo "=========================================="
    echo ""
    echo "Run the following command BEFORE installing OpenterfaceQT:"
    echo ""
    echo "  sudo apt-get update"
    echo "  sudo apt-get install -y \\"
    for i in "${!MISSING_DEPS[@]}"; do
        if [ $i -lt $((${#MISSING_DEPS[@]} - 1)) ]; then
            echo "    ${MISSING_DEPS[$i]} \\"
        else
            echo "    ${MISSING_DEPS[$i]}"
        fi
    done
    echo ""
    echo "Or install all dependencies at once:"
    echo ""
    echo "  sudo apt-get update && sudo apt-get install -y \\"
    for i in "${!CRITICAL_DEPS[@]}"; do
        if [ $i -lt $((${#CRITICAL_DEPS[@]} - 1)) ]; then
            echo "    ${CRITICAL_DEPS[$i]} \\"
        else
            echo "    ${CRITICAL_DEPS[$i]}"
        fi
    done
    echo ""
    echo "=========================================="
    echo ""
    exit 1
fi
