#!/bin/bash
# =============================================================================
# OpenterfaceQT Pre-Installation Script
# =============================================================================
#
# This script runs BEFORE the DEB package is unpacked and installed.
# It ensures all required runtime dependencies are installed first.
#
# Dependencies installed:
#   - Graphics: libegl1, libgles2, libva-api libraries
#   - Audio: libpulse0
#   - Video: libgstreamer1.0-0, libgstreamer-plugins-base1.0-0, libv4l-0
#   - X11/Display: libxcb*, libx11-6, libwayland-client0, libxkbcommon0
#   - Compression: zlib1g, libbz2-1.0, liblzma5
#
# =============================================================================

# Note: We do NOT use 'set -e' because we want to continue even if some apt-get commands fail
# The preinst script should be resilient and not block package installation

echo "=========================================="
echo "OpenterfaceQT Pre-Installation Script"
echo "=========================================="
echo ""

# Function to print status messages
print_status() {
    echo "üì¶ $1"
}

print_success() {
    echo "‚úÖ $1"
}

print_warning() {
    echo "‚ö†Ô∏è  $1"
}

print_error() {
    echo "‚ùå $1"
}

# Function to run apt-get with retry logic for dpkg lock issues
apt_get_with_retry() {
    local max_retries=5
    local retry_interval=3
    local attempt=1
    
    while [ $attempt -le $max_retries ]; do
        if apt-get "$@" 2>&1 | tee /tmp/apt_install.log; then
            return 0
        fi
        
        # Check if error is dpkg lock related
        if grep -q "Could not get lock\|Unable to acquire the dpkg" /tmp/apt_install.log; then
            if [ $attempt -lt $max_retries ]; then
                print_warning "dpkg lock detected (attempt $attempt/$max_retries), waiting before retry..."
                sleep $retry_interval
                attempt=$((attempt + 1))
            else
                print_warning "dpkg lock persists after $max_retries attempts, continuing..."
                return 1
            fi
        else
            # Non-lock error, don't retry
            return 1
        fi
    done
    
    return 1
}

# Check if running with apt/dpkg
if [ "$1" != "install" ] && [ "$1" != "upgrade" ]; then
    echo "Pre-installation script called with: $1"
    exit 0
fi

print_status "Starting pre-installation dependency check and installation..."
echo ""

# Function to wait for dpkg lock to be released
wait_for_dpkg_lock() {
    local max_wait=300  # Maximum 5 minutes wait
    local wait_interval=2
    local elapsed=0
    
    while [ $elapsed -lt $max_wait ]; do
        if ! fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; then
            return 0
        fi
        
        if [ $elapsed -eq 0 ]; then
            print_warning "Waiting for dpkg lock to be released..."
        fi
        
        sleep $wait_interval
        elapsed=$((elapsed + wait_interval))
        
        if [ $((elapsed % 10)) -eq 0 ]; then
            print_warning "Still waiting for dpkg lock ($elapsed seconds)..."
        fi
    done
    
    print_error "Timeout waiting for dpkg lock after ${max_wait}s"
    return 1
}

# Wait for any existing dpkg operations to complete
wait_for_dpkg_lock

# Step 1: Update package lists
print_status "Updating package repository lists..."
if apt_get_with_retry update -qq 2>&1 | grep -v "^Get:\|^Hit:\|^Reading" || true; then
    print_success "Package lists updated"
else
    print_warning "apt-get update encountered issues, but continuing..."
fi

echo ""

# Step 2: Install graphics and rendering libraries
print_status "Installing graphics and GPU libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libegl1 libgles2 2>&1 | tee /tmp/apt_install.log; then
    print_success "Graphics libraries installed"
    # Verify installation
    if dpkg -l | grep -q "libegl1" && dpkg -l | grep -q "libgles2"; then
        print_success "Graphics libraries verified"
    else
        print_warning "Graphics libraries may not be fully installed, attempting alternative installation..."
        apt_get_with_retry install -y --no-install-recommends -qq libegl1-mesa libgles2-mesa || true
    fi
else
    EXIT_CODE=$?
    print_warning "apt-get install returned exit code: $EXIT_CODE"
    print_warning "Output:"
    cat /tmp/apt_install.log | sed 's/^/    /'
    print_warning "Attempting alternative graphics library installation..."
    apt_get_with_retry install -y --no-install-recommends -qq libegl1-mesa libgles2-mesa || print_warning "Failed to install graphics libraries, but continuing with installation..."
fi

# Step 3: Install audio libraries
print_status "Installing audio libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libpulse0 2>&1 | tee /tmp/apt_install.log; then
    print_success "Audio libraries installed"
    # Verify installation
    if dpkg -l | grep -q "libpulse0"; then
        print_success "Audio libraries verified"
    else
        print_warning "Audio libraries may not be fully installed, attempting alternative installation..."
        apt_get_with_retry install -y --no-install-recommends -qq libpulse0 libpulse-mainloop-glib0 || true
    fi
else
    print_warning "Audio libraries installation encountered issues, attempting alternative..."
    apt_get_with_retry install -y --no-install-recommends -qq libpulse0 libpulse-mainloop-glib0 || print_warning "Audio libraries installation failed, but continuing..."
fi

# Step 4: Install video acceleration libraries
print_status "Installing video acceleration libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libva2 libva-drm2 libva-x11-2 2>&1 | tee /tmp/apt_install.log; then
    print_success "Video acceleration libraries installed"
else
    print_warning "Video acceleration libraries installation attempted (may already exist or have conflicts)"
fi

# Step 5: Install GStreamer multimedia framework
print_status "Installing GStreamer multimedia framework..."
if apt_get_with_retry install -y --no-install-recommends -qq libgstreamer1.0-0 libgstreamer-plugins-base1.0-0 2>&1 | tee /tmp/apt_install.log; then
    print_success "GStreamer libraries installed"
    # Verify installation
    if dpkg -l | grep -q "libgstreamer1.0-0"; then
        print_success "GStreamer libraries verified"
    else
        print_warning "GStreamer libraries may not be fully installed, attempting fallback installation..."
        apt_get_with_retry install -y --no-install-recommends -qq gstreamer1.0-tools || true
    fi
else
    print_warning "GStreamer libraries installation encountered issues, attempting alternative..."
    apt_get_with_retry install -y --no-install-recommends -qq gstreamer1.0-tools || print_warning "GStreamer installation failed, but continuing..."
fi

# Step 6: Install Video4Linux libraries
print_status "Installing Video4Linux libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libv4l-0 2>&1 | tee /tmp/apt_install.log; then
    print_success "Video4Linux libraries installed"
    # Verify installation
    if dpkg -l | grep -q "libv4l-0"; then
        print_success "Video4Linux libraries verified"
    else
        print_warning "Video4Linux libraries may not be fully installed, attempting fallback..."
        apt_get_with_retry install -y --no-install-recommends -qq libv4l libv4lconvert0 || true
    fi
else
    print_warning "Video4Linux libraries installation encountered issues, attempting fallback..."
    apt_get_with_retry install -y --no-install-recommends -qq libv4l libv4lconvert0 || print_warning "Video4Linux installation failed, but continuing..."
fi

# Step 7: Install X11 and display server libraries
print_status "Installing X11 and display server libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq \
    libxkbcommon0 \
    libwayland-client0 \
    libxcb1 \
    libxcb-shm0 \
    libxcb-xfixes0 \
    libxcb-shape0 \
    libx11-6 2>&1 | tee /tmp/apt_install.log; then
    print_success "X11 and display libraries installed"
else
    print_warning "X11 libraries installation attempted (may already exist or have conflicts)"
fi

# Step 8: Install FFmpeg libraries
print_status "Installing FFmpeg libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libavformat60 libavcodec60 libavutil58 libavdevice60 libswresample4 libswscale7 2>&1 | tee /tmp/apt_install.log; then
    print_success "FFmpeg libraries installed"
else
    print_warning "FFmpeg libraries installation attempted (may already exist or have conflicts)"
fi

# Step 9: Install GStreamer plugins
print_status "Installing GStreamer plugins..."
if apt_get_with_retry install -y --no-install-recommends -qq \
    gstreamer1.0-plugins-base \
    gstreamer1.0-plugins-good \
    gstreamer1.0-plugins-bad \
    gstreamer1.0-plugins-ugly \
    gstreamer1.0-libav \
    gstreamer1.0-alsa \
    gstreamer1.0-pulseaudio 2>&1 | tee /tmp/apt_install.log; then
    print_success "GStreamer plugins installed"
else
    print_warning "GStreamer plugins installation attempted (may already exist or have conflicts)"
fi

# Step 10: Install JPEG libraries for image handling
print_status "Installing JPEG libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq libturbojpeg0 2>&1 | tee /tmp/apt_install.log; then
    print_success "JPEG libraries installed"
else
    print_warning "JPEG libraries installation attempted (may already exist or have conflicts)"
fi

# Step 11: Install Video4Linux utilities
print_status "Installing Video4Linux utilities..."
if apt_get_with_retry install -y --no-install-recommends -qq v4l-utils 2>&1 | tee /tmp/apt_install.log; then
    print_success "Video4Linux utilities installed"
else
    print_warning "Video4Linux utilities installation attempted (may already exist or have conflicts)"
fi

# Step 12: Install compression libraries
print_status "Installing compression libraries..."
if apt_get_with_retry install -y --no-install-recommends -qq zlib1g libbz2-1.0 liblzma5 2>&1 | tee /tmp/apt_install.log; then
    print_success "Compression libraries installed"
else
    print_warning "Compression libraries installation attempted (may already exist or have conflicts)"
fi

echo ""
echo "=========================================="
print_success "All dependencies installed successfully!"
echo "=========================================="
echo ""

# Summary
print_status "Dependencies installed:"
echo "  ‚úì Graphics: libegl1, libgles2"
echo "  ‚úì Audio: libpulse0"
echo "  ‚úì Video Acceleration: libva2, libva-drm2, libva-x11-2"
echo "  ‚úì GStreamer: libgstreamer1.0-0, libgstreamer-plugins-base1.0-0"
echo "  ‚úì GStreamer Plugins: gstreamer1.0-plugins-{base,good,bad,ugly,libav,alsa,pulseaudio}"
echo "  ‚úì FFmpeg: libavformat60, libavcodec60, libavutil58, libavdevice60, libswresample4, libswscale7"
echo "  ‚úì JPEG: libturbojpeg0"
echo "  ‚úì Video4Linux: libv4l-0, v4l-utils"
echo "  ‚úì X11/Display: libxkbcommon0, libwayland-client0, libxcb*, libx11-6"
echo "  ‚úì Compression: zlib1g, libbz2-1.0, liblzma5"
echo ""

# Verification of critical dependencies
print_status "Verifying critical dependencies..."
echo ""

MISSING_DEPS=0

check_package() {
    local pkg=$1
    if dpkg -l | grep -q "^ii.*$pkg"; then
        echo "  ‚úÖ $pkg found"
    else
        echo "  ‚ùå $pkg not found"
        MISSING_DEPS=$((MISSING_DEPS + 1))
    fi
}

echo "Critical dependencies check:"
check_package "libegl1"
check_package "libgles2"
check_package "libpulse0"
check_package "libgstreamer1.0-0"
check_package "libv4l-0"

echo ""
if [ $MISSING_DEPS -gt 0 ]; then
    print_warning "‚ö†Ô∏è  $MISSING_DEPS critical dependencies not found after installation"
    print_warning "This may cause issues, but the package installation will continue"
    print_warning "Please manually install missing packages after installation if needed"
else
    print_success "All critical dependencies verified!"
fi

echo ""
print_status "Proceeding with OpenterfaceQT package installation..."
echo ""

exit 0
