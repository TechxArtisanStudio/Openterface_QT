# Dockerfile for Testing Openterface QT Application on Windows
# This Dockerfile creates a Windows Server testing environment for the Openterface QT application
# Windows Server 2022 LTSC base image with runtime dependencies for GUI testing
#
# IMPORTANT: This Dockerfile requires Windows Docker Desktop or Windows Server with Docker
# Linux containers cannot run Windows applications
#
# Build:
#   docker build -t openterface-qt:windows-test -f docker/testos/Dockerfile.windows-test-shared .
#
# Run:
#   docker run -it --name openterface-test ^
#     -e INSTALL_TYPE=exe ^
#     -v C:\packages:/tmp/build-artifacts ^
#     openterface-qt:windows-test

# Use Windows Server 2022 LTSC as base (smallest Windows Server image suitable for containers)
# Using generic ltsc2022 tag for broader compatibility and availability
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Build arguments
ARG GITHUB_TOKEN=""
ARG INSTALL_TYPE="exe"

# Set environment variables for testing
ENV GITHUB_TOKEN=${GITHUB_TOKEN}
ENV INSTALL_TYPE=${INSTALL_TYPE}
ENV TEMP=C:\temp
ENV TMP=C:\temp

# === Stage 1: System Setup and Dependencies ===
# Install Chocolatey package manager for easier dependency installation
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command " \
    [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; \
    iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))" && \
    setx PATH "%PATH%;C:\ProgramData\chocolatey\bin"

# === Stage 2: Install Runtime Dependencies ===
# Core utilities and tools required for testing
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command \
    "choco install -y curl wget git jq usbview hwinfo --no-progress"

# === Stage 3: Install Visual C++ Runtimes ===
# Required by Qt6 libraries and other system components
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command \
    "choco install -y vcredist140 vcredist2015 dotnet-runtime --no-progress"

# === Stage 4: Create Installation and Working Directories ===
RUN powershell -NoProfile -InputFormat None -ExecutionPolicy Bypass -Command \
    "mkdir -Force 'C:\tmp\build-artifacts' -ErrorAction SilentlyContinue | Out-Null; \
    mkdir -Force 'C:\tmp\packages' -ErrorAction SilentlyContinue | Out-Null; \
    mkdir -Force 'C:\scripts' -ErrorAction SilentlyContinue | Out-Null; \
    mkdir -Force 'C:\docker' -ErrorAction SilentlyContinue | Out-Null"

# === Stage 5: Set Working Directory ===
WORKDIR C:\home\openterface

# === Stage 6: Add Labels for Metadata ===
LABEL maintainer="TechxArtisan Studio"
LABEL description="Openterface QT Mini-KVM Windows testing environment"
LABEL version="latest"
LABEL purpose="testing"

# === Stage 7: Set Entrypoint ===
ENTRYPOINT ["powershell", "-NoProfile", "-InputFormat", "None", "-ExecutionPolicy", "Bypass", "-File", "C:\\entrypoint.ps1"]
