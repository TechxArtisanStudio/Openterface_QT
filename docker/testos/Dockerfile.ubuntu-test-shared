# Dockerfile for Testing Openterface QT Application
# This Dockerfile creates a clean testing environment for the Openterface QT application
# Downloads and installs the prebuilt package with runtime dependencies only

FROM ubuntu:24.04

# Set environment variables to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Set up display environment for GUI applications
ENV DISPLAY=:0
ENV QT_X11_NO_MITSHM=1
ENV QT_QPA_PLATFORM=xcb

# Install minimal system dependencies and runtime libraries only
RUN apt-get update -y --allow-releaseinfo-change --allow-unauthenticated
RUN apt-get install -y \
        # Essential utilities
        curl \
        wget \
        ca-certificates \
        sudo \
        udev \
        usbutils
# Runtime Qt6 libraries
RUN apt-get install -y libqt6core6t64 \
        libqt6dbus6t64 \
        libqt6gui6t64 \
        libqt6widgets6t64 \
        libqt6network6t64 \
        libqt6multimedia6 \
        libqt6multimediawidgets6 \
        libqt6serialport6 \
        libqt6svg6
# Hardware interface libraries (runtime only)
RUN apt-get install -y libusb-1.0-0 \
        libudev1
# X11 and graphics libraries (runtime only)
RUN apt-get install -y libx11-6 \
        libxrandr2 \
        libxrender1 \
        libexpat1 \
        libfreetype6 \
        libfontconfig1 \
        libbz2-1.0
# FFmpeg runtime libraries
RUN apt-get install -y libavformat60 \
        libavcodec60 \
        libavutil58 \
        libavdevice60 \
        libswresample4 \
        libswscale7 \
        libturbojpeg
# GStreamer runtime dependencies
RUN apt-get install -y libgstreamer1.0-0 \
        gstreamer1.0-plugins-base \
        gstreamer1.0-plugins-good \
        gstreamer1.0-plugins-bad \
        gstreamer1.0-plugins-ugly \
        gstreamer1.0-libav \
        gstreamer1.0-alsa \
        gstreamer1.0-pulseaudio
# Clean up to reduce image size
 RUN   apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a non-root user for running the application
RUN useradd -m -s /bin/bash openterface && \
    usermod -a -G dialout,uucp,audio,video openterface && \
    echo "openterface ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Copy build artifacts (if available in Docker build context)
# These will be used by the install script in preference to downloading from GitHub
# The install script will look for .deb files in /tmp/build-artifacts and /tmp directories
COPY build/ /tmp/build-artifacts/

# Copy and run the installation script
COPY install-openterface-shared.sh /tmp/install-openterface-shared.sh
RUN chmod +x /tmp/install-openterface-shared.sh && \
    /tmp/install-openterface-shared.sh && \
    rm /tmp/install-openterface-shared.sh


# Set up udev rules for Openterface hardware (backup rules, main setup in install script)
RUN echo 'SUBSYSTEM=="hidraw", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' > /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="ttyUSB", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules

# Switch to non-root user
USER openterface

# Set the working directory
WORKDIR /home/openterface

# Add labels for metadata
LABEL maintainer="TechxArtisan Studio"
LABEL description="Openterface QT Mini-KVM testing environment"
LABEL version="latest"
LABEL purpose="testing"

# Default command to run the application
CMD ["/usr/local/bin/start-openterface.sh"]
