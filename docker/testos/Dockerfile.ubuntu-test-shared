# Dockerfile for Testing Openterface QT Application
# This Dockerfile creates a clean testing environment for the Openterface QT application
# Downloads and installs the prebuilt package with runtime dependencies only

FROM ubuntu:24.04

# Build arguments
ARG GITHUB_TOKEN=""

# Set environment variables to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC
ENV GITHUB_TOKEN=${GITHUB_TOKEN}

# Set up display environment for GUI applications
ENV DISPLAY=:0
ENV QT_X11_NO_MITSHM=1
ENV QT_QPA_PLATFORM=xcb

# Set locale to UTF-8 (required by Qt6)
ENV LC_ALL=C.UTF-8
ENV LANG=C.UTF-8

# Install minimal system dependencies and runtime libraries only
RUN apt-get update -y --allow-releaseinfo-change --allow-unauthenticated
RUN apt-get install -y \
        # Essential utilities
        curl \
        wget \
        ca-certificates \
        jq \
        sudo \
        udev \
        usbutils
# Hardware interface libraries (runtime only)
RUN apt-get install -y libusb-1.0-0 \
        libudev1
        
# Runtime dependencies for bundled Qt6 libraries
RUN apt-get install -y libpcre2-16-0 \
        libssl3 \
        libzstd1 \
        libbrotli1

# X11 and graphics libraries (runtime only)
RUN apt-get install -y libx11-6 \
        libxrandr2 \
        libxrender1 \
        libxfixes3 \
        libxcursor1 \
        libxcb-cursor0 \
        libxinerama1 \
        libxi6 \
        libxext6 \
        libxcb1 \
        libxcb-shape0 \
        libxcb-xfixes0 \
        libxcb-shm0 \
        libxkbcommon0 \
        libxkbcommon-x11-0 \
        libexpat1 \
        libfreetype6 \
        libfontconfig1 \
        libbz2-1.0 \
        libxcb-render0 \
        libxcb-render-util0 \
        libxcb-image0 \
        libxcb-util1 \
        libxcb-keysyms1 \
        libxcb-icccm4
# OpenGL and GPU libraries for rendering
RUN apt-get install -y libgl1 \
        libglx0 \
        libglvnd0 \
        libglu1-mesa
# FFmpeg runtime libraries
RUN apt-get install -y libavformat60 \
        libavcodec60 \
        libavutil58 \
        libavdevice60 \
        libswresample4 \
        libswscale7 \
        libturbojpeg
# GStreamer runtime dependencies
RUN apt-get install -y libgstreamer1.0-0 \
        gstreamer1.0-plugins-base \
        gstreamer1.0-plugins-good \
        gstreamer1.0-plugins-bad \
        gstreamer1.0-plugins-ugly \
        gstreamer1.0-libav \
        gstreamer1.0-alsa \
        gstreamer1.0-pulseaudio
# Clean up to reduce image size
 RUN   apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Create a non-root user for running the application
RUN useradd -m -s /bin/bash openterface && \
    usermod -a -G dialout,uucp,audio,video,sudo openterface && \
    echo "openterface ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/openterface && \
    chmod 0440 /etc/sudoers.d/openterface && \
    mkdir -p /var/lib/apt/lists/partial && \
    chown -R openterface:openterface /var/lib/apt/lists /var/cache/apt

# Create directories for potential build artifacts and temporary files
RUN mkdir -p /tmp/build-artifacts /tmp/packages && \
    chown -R openterface:openterface /tmp/build-artifacts /tmp/packages

# Note: Build artifacts are not copied into the image.
# The installation script will either:
# 1. Find .deb files if they were mounted at runtime via docker run -v
# 2. Download the latest release from GitHub

# Copy installation script for runtime execution
COPY ./install-openterface-shared.sh /tmp/install-openterface-shared.sh
RUN chmod +x /tmp/install-openterface-shared.sh

# Copy and setup entrypoint script
COPY ./entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh


# Set up udev rules for Openterface hardware (backup rules, main setup in install script)
RUN echo 'SUBSYSTEM=="hidraw", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' > /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="ttyUSB", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-backup.rules

# Create a diagnostic script to check Qt plugin dependencies (BEFORE USER switch)
RUN mkdir -p /usr/local/bin && \
    printf '#!/bin/bash\n' > /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "ðŸ” Qt Plugin Dependency Diagnostics"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "===================================="\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo ""\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "Qt xcb platform plugin location:"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'find / -name "libqxcb.so" 2>/dev/null | head -5\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo ""\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "Checking xcb plugin library dependencies:"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'if command -v ldd >/dev/null 2>&1; then\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf '    xcb_plugin=$(find / -name "libqxcb.so" 2>/dev/null | head -1)\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf '    if [ -f "$xcb_plugin" ]; then\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf '        echo "Dependencies for: $xcb_plugin"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf '        ldd "$xcb_plugin" 2>&1 | grep -E "not found|libxcb"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf '    fi\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'fi\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo ""\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "Checking for xcb-cursor library:"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'dpkg -l | grep -i "xcb-cursor\\|libxcb-cursor"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo ""\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "Checking for all libxcb libraries:"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'dpkg -l | grep "libxcb"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo ""\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "Qt plugin path environment variables:"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "QT_PLUGIN_PATH=$$QT_PLUGIN_PATH"\n' >> /usr/local/bin/check-qt-deps.sh && \
    printf 'echo "QML2_IMPORT_PATH=$$QML2_IMPORT_PATH"\n' >> /usr/local/bin/check-qt-deps.sh && \
    chmod +x /usr/local/bin/check-qt-deps.sh

# Switch to non-root user
USER openterface

# Set the working directory
WORKDIR /home/openterface

# Add labels for metadata
LABEL maintainer="TechxArtisan Studio"
LABEL description="Openterface QT Mini-KVM testing environment"
LABEL version="latest"
LABEL purpose="testing"

# Set entrypoint to handle installation on first run
ENTRYPOINT ["/entrypoint.sh"]

# Default command (will be passed to entrypoint)
CMD ["/bin/bash"]
