# Dockerfile for Testing Openterface QT Static Application on Arch Linux
# This Dockerfile creates a minimal testing environment for the statically-linked Openterface QT application
# Downloads and installs the prebuilt static package with minimal runtime dependencies

FROM archlinux:latest

# Set environment variables to avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=UTC

# Set up display environment for GUI applications
ENV DISPLAY=:0
ENV QT_X11_NO_MITSHM=1
ENV QT_QPA_PLATFORM=xcb

# Update package database and install minimal system dependencies for static builds
# Static builds require fewer runtime libraries since most are embedded
RUN pacman -Syu --noconfirm \
        # Essential utilities
        curl \
        wget \
        ca-certificates \
        sudo \
        systemd \
        # Network diagnostic tools
        iputils \
        bind-tools \
        gnu-netcat \
        file

# Minimal X11 and graphics libraries (only what's absolutely needed for static builds)
RUN pacman -S --noconfirm \
        libx11 \
        libxrandr \
        libxrender \
        expat \
        freetype2 \
        fontconfig \
        bzip2 \
        libxcb \
        xcb-util-xinerama \
        xcb-util-randr

# Hardware interface libraries (always needed for USB/HID access)
RUN pacman -S --noconfirm systemd

# Audio libraries (minimal set for static builds)
RUN pacman -S --noconfirm \
        alsa-lib \
        libpulse

# Essential C/C++ runtime libraries
RUN pacman -S --noconfirm \
        glibc \
        gcc-libs

# Clean up to reduce image size
RUN pacman -Scc --noconfirm

# Create a non-root user for running the application
RUN useradd -m -s /bin/bash openterface && \
    usermod -a -G uucp,audio,video openterface && \
    echo "openterface ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# Copy and run the static installation script
COPY install-openterface-static.sh /tmp/install-openterface-static.sh
RUN echo "=== DEBUG: Starting installation script ===" && \
    chmod +x /tmp/install-openterface-static.sh && \
    echo "=== DEBUG: Script permissions set ===" && \
    ls -la /tmp/install-openterface-static.sh && \
    echo "=== DEBUG: Network connectivity test ===" && \
    curl -I --connect-timeout 10 --max-time 30 https://api.github.com/repos/TechxArtisanStudio/Openterface_QT/releases/latest || echo "GitHub API connection failed" && \
    echo "=== DEBUG: Running installation script with verbose output ===" && \
    bash -x /tmp/install-openterface-static.sh && \
    echo "=== DEBUG: Installation script completed ===" && \
    rm /tmp/install-openterface-static.sh

# Set up udev rules for Openterface hardware
RUN echo 'SUBSYSTEM=="hidraw", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' > /etc/udev/rules.d/50-openterface-static.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="534d", ATTRS{idProduct}=="2109", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-static.rules && \
    echo 'SUBSYSTEM=="ttyUSB", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-static.rules && \
    echo 'SUBSYSTEM=="usb", ATTRS{idVendor}=="1a86", ATTRS{idProduct}=="7523", TAG+="uaccess", MODE="0666"' >> /etc/udev/rules.d/50-openterface-static.rules

# Switch to non-root user
USER openterface

# Set the working directory
WORKDIR /home/openterface

# Add labels for metadata
LABEL maintainer="TechxArtisan Studio"
LABEL description="Openterface QT Mini-KVM static testing environment"
LABEL version="latest"
LABEL purpose="static-testing"
LABEL build-type="static"

# Default command to run the application
CMD ["/usr/local/bin/start-openterface.sh"]
